<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Inicializar Firebase Collections</title>
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { 
            getFirestore, 
            collection, 
            addDoc,
            serverTimestamp 
        } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';

        const firebaseConfig = {
            apiKey: "AIzaSyCBwly1pkKYfH0tdcfnQMb1-A8sjOyuqtU",
            authDomain: "gestcloud-9d02f.firebaseapp.com",
            databaseURL: "https://gestcloud-9d02f-default-rtdb.firebaseio.com/",
            projectId: "gestcloud-9d02f",
            storageBucket: "gestcloud-9d02f.firebasestorage.app",
            messagingSenderId: "493348332872",
            appId: "1:493348332872:web:3e9540d0f567e4bc573f7d"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // Funci√≥n para inicializar la colecci√≥n de historial
        async function inicializarHistorial() {
            try {
                console.log('üîß Inicializando colecci√≥n visitantes_historial...');
                
                const docInicializacion = {
                    _tipo: 'documento_inicializacion',
                    _descripcion: 'Este documento inicializa la colecci√≥n visitantes_historial',
                    _fechaCreacion: serverTimestamp(),
                    _eliminar: true // Marcar para eliminar despu√©s
                };
                
                const docRef = await addDoc(collection(db, 'visitantes_historial'), docInicializacion);
                console.log('‚úÖ Colecci√≥n visitantes_historial inicializada con documento:', docRef.id);
                
                document.getElementById('resultado').innerHTML += `
                    <div style="color: green; margin: 10px 0;">
                        ‚úÖ Colecci√≥n 'visitantes_historial' creada exitosamente<br>
                        ID del documento de inicializaci√≥n: ${docRef.id}
                    </div>
                `;
                
                return docRef.id;
            } catch (error) {
                console.error('‚ùå Error inicializando historial:', error);
                document.getElementById('resultado').innerHTML += `
                    <div style="color: red; margin: 10px 0;">
                        ‚ùå Error: ${error.message}
                    </div>
                `;
            }
        }

        // Funci√≥n para agregar un visitante de ejemplo y luego darle salida
        async function pruebaCompleta() {
            try {
                document.getElementById('resultado').innerHTML = '<h3>üîÑ Ejecutando prueba completa...</h3>';
                
                // 1. Inicializar historial
                await inicializarHistorial();
                
                // 2. Agregar visitante de prueba
                console.log('üë§ Agregando visitante de prueba...');
                const visitantePrueba = {
                    nombre: 'Ana Garc√≠a',
                    cedula: '87654321',
                    celular: '310 987 6543',
                    apartamento: 'B-205',
                    motivoVisita: 'Prueba de sistema de salida',
                    tiempoEntrada: serverTimestamp(),
                    fechaCreacion: new Date().toISOString(),
                    activo: true
                };
                
                const visitanteRef = await addDoc(collection(db, 'visitantes'), visitantePrueba);
                console.log('‚úÖ Visitante agregado:', visitanteRef.id);
                
                document.getElementById('resultado').innerHTML += `
                    <div style="color: blue; margin: 10px 0;">
                        üë§ Visitante de prueba agregado: ${visitanteRef.id}
                    </div>
                `;
                
                // 3. Esperar un momento y luego dar salida
                setTimeout(async () => {
                    try {
                        console.log('üö™ Dando salida al visitante...');
                        await window.debugDarSalida(visitanteRef.id);
                        
                        document.getElementById('resultado').innerHTML += `
                            <div style="color: green; margin: 10px 0;">
                                üö™ Salida completada exitosamente para: ${visitanteRef.id}
                            </div>
                        `;
                    } catch (error) {
                        console.error('‚ùå Error en salida:', error);
                        document.getElementById('resultado').innerHTML += `
                            <div style="color: red; margin: 10px 0;">
                                ‚ùå Error en salida: ${error.message}
                            </div>
                        `;
                    }
                }, 2000);
                
            } catch (error) {
                console.error('‚ùå Error en prueba completa:', error);
                document.getElementById('resultado').innerHTML += `
                    <div style="color: red; margin: 10px 0;">
                        ‚ùå Error general: ${error.message}
                    </div>
                `;
            }
        }

        // Hacer funciones disponibles globalmente
        window.inicializarHistorial = inicializarHistorial;
        window.pruebaCompleta = pruebaCompleta;
        
        // Importar funci√≥n de debug desde el otro archivo
        window.debugDarSalida = async (visitanteId) => {
            const { runTransaction, doc, collection, serverTimestamp } = await import('https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js');
            
            return await runTransaction(db, async (transaction) => {
                const visitanteRef = doc(db, 'visitantes', visitanteId);
                const visitanteDoc = await transaction.get(visitanteRef);
                
                if (!visitanteDoc.exists()) {
                    throw new Error('Visitante no encontrado');
                }
                
                const datosVisitante = visitanteDoc.data();
                
                const tiempoEntrada = datosVisitante.tiempoEntrada?.toDate ? 
                    datosVisitante.tiempoEntrada.toDate() : 
                    new Date(datosVisitante.fechaCreacion);
                
                const tiempoSalida = new Date();
                const tiempoTotal = Math.floor((tiempoSalida - tiempoEntrada) / 1000);
                
                const datosHistorial = {
                    ...datosVisitante,
                    tiempoSalida: serverTimestamp(),
                    fechaSalida: tiempoSalida.toISOString(),
                    tiempoTotal,
                    activo: false
                };
                
                const historialRef = doc(collection(db, 'visitantes_historial'));
                transaction.set(historialRef, datosHistorial);
                transaction.delete(visitanteRef);
                
                return true;
            });
        };
    </script>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; max-width: 800px; }
        button { margin: 10px 5px; padding: 12px 20px; cursor: pointer; border: none; border-radius: 5px; }
        .btn-primary { background-color: #3b82f6; color: white; }
        .btn-success { background-color: #10b981; color: white; }
        #resultado { border: 1px solid #ccc; padding: 15px; margin-top: 20px; border-radius: 5px; }
    </style>
</head>
<body>
    <h1>üîß Inicializaci√≥n de Firebase Collections</h1>
    
    <p>Esta herramienta te ayudar√° a crear la colecci√≥n <code>visitantes_historial</code> en Firebase y probar el sistema de dar salida.</p>
    
    <div>
        <button onclick="inicializarHistorial()" class="btn-primary">
            üöÄ Inicializar Colecci√≥n Historial
        </button>
        
        <button onclick="pruebaCompleta()" class="btn-success">
            üß™ Prueba Completa (Crear colecci√≥n + Probar salida)
        </button>
    </div>
    
    <div id="resultado">
        <p>Haz clic en uno de los botones arriba para comenzar.</p>
    </div>
    
    <h2>üìù Instrucciones</h2>
    <ol>
        <li><strong>Inicializar Colecci√≥n:</strong> Crea la colecci√≥n <code>visitantes_historial</code> con un documento inicial</li>
        <li><strong>Prueba Completa:</strong> Crea la colecci√≥n, agrega un visitante y le da salida autom√°ticamente</li>
        <li>Despu√©s de esto, el sistema principal deber√≠a funcionar sin problemas</li>
    </ol>
    
    <h2>üîç Debug</h2>
    <p>Abre las herramientas de desarrollador (F12) para ver logs detallados.</p>
</body>
</html>

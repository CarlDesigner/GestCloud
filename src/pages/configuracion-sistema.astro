---
import LayoutSidebar from '../app/LayoutSidebar.astro';
---

<LayoutSidebar title="Configuraci√≥n del Sistema">
  <div class="p-4 bg-white block sm:flex items-center justify-between border-b border-gray-200 lg:mt-1.5 dark:bg-gray-800 dark:border-gray-700">
    <div class="w-full mb-1">
      <div class="mb-4">
        <nav class="flex mb-5" aria-label="Breadcrumb">
          <ol class="inline-flex items-center space-x-1 text-sm font-medium md:space-x-2">
            <li class="inline-flex items-center">
              <a href="#" class="inline-flex items-center text-gray-700 hover:text-primary-600 dark:text-gray-300 dark:hover:text-white">
                <svg class="w-5 h-5 mr-2.5" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg">
                  <path d="M10.707 2.293a1 1 0 00-1.414 0l-7 7a1 1 0 001.414 1.414L4 10.414V17a1 1 0 001 1h2a1 1 0 001-1v-2a1 1 0 011-1h2a1 1 0 011 1v2a1 1 0 001 1h2a1 1 0 001-1v-6.586l.293.293a1 1 0 001.414-1.414l-7-7z"></path>
                </svg>
                Sistema
              </a>
            </li>
            <li>
              <div class="flex items-center">
                <svg class="w-6 h-6 text-gray-400" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg">
                  <path fill-rule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z" clip-rule="evenodd"></path>
                </svg>
                <span class="ml-1 text-gray-400 md:ml-2 dark:text-gray-500" aria-current="page">Configuraci√≥n</span>
              </div>
            </li>
          </ol>
        </nav>
        <h1 class="text-xl font-semibold text-gray-900 sm:text-2xl dark:text-white">‚öôÔ∏è Configuraci√≥n del Sistema</h1>
        <p class="text-gray-600 dark:text-gray-400 mt-2">Configuraci√≥n inicial y mantenimiento de GestCloud</p>
      </div>
    </div>
  </div>

  <!-- Contenido Principal -->
  <div class="flex flex-col">
    <div class="overflow-x-auto">
      <div class="align-middle inline-block min-w-full">
        <div class="shadow overflow-hidden">
          
          <!-- Inicializaci√≥n de Base de Datos -->
          <div class="bg-white dark:bg-gray-800 p-6 m-4 rounded-lg border border-gray-200 dark:border-gray-700">
            <div class="mb-6">
              <h2 class="text-lg font-semibold text-gray-900 dark:text-white mb-2">üóÑÔ∏è Inicializaci√≥n de Base de Datos</h2>
              <p class="text-gray-600 dark:text-gray-400 mb-4">
                Si es la primera vez que usas el sistema o tienes problemas con el historial de visitantes, 
                ejecuta la inicializaci√≥n para crear las colecciones necesarias en Firebase.
              </p>
              
              <div class="flex flex-col sm:flex-row gap-4">
                <button id="btn-inicializar" 
                        class="inline-flex items-center px-5 py-3 text-sm font-medium text-center text-white bg-primary-700 rounded-lg hover:bg-primary-800 focus:ring-4 focus:outline-none focus:ring-primary-300 dark:bg-primary-600 dark:hover:bg-primary-700 dark:focus:ring-primary-800">
                  üöÄ Inicializar Colecciones
                </button>
                
                <button id="btn-test-salida" 
                        class="inline-flex items-center px-5 py-3 text-sm font-medium text-center text-white bg-green-700 rounded-lg hover:bg-green-800 focus:ring-4 focus:outline-none focus:ring-green-300 dark:bg-green-600 dark:hover:bg-green-700 dark:focus:ring-green-800">
                  üß™ Probar Sistema de Salida
                </button>
              </div>
            </div>
            
            <!-- Estado del sistema -->
            <div id="estado-sistema" class="mt-6 p-4 bg-gray-50 dark:bg-gray-700 rounded-lg">
              <h3 class="font-medium text-gray-900 dark:text-white mb-2">üìä Estado del Sistema</h3>
              <div id="mensaje-estado" class="text-sm text-gray-600 dark:text-gray-400">
                Haz clic en "Inicializar Colecciones" para verificar el estado del sistema.
              </div>
            </div>
          </div>

          <!-- Informaci√≥n del Sistema -->
          <div class="bg-white dark:bg-gray-800 p-6 m-4 rounded-lg border border-gray-200 dark:border-gray-700">
            <h2 class="text-lg font-semibold text-gray-900 dark:text-white mb-2">‚ÑπÔ∏è Informaci√≥n del Sistema</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm">
              <div>
                <strong class="text-gray-900 dark:text-white">Versi√≥n:</strong>
                <span class="text-gray-600 dark:text-gray-400">GestCloud v1.0</span>
              </div>
              <div>
                <strong class="text-gray-900 dark:text-white">Base de Datos:</strong>
                <span class="text-gray-600 dark:text-gray-400">Firebase Firestore</span>
              </div>
              <div>
                <strong class="text-gray-900 dark:text-white">Proyecto:</strong>
                <span class="text-gray-600 dark:text-gray-400">gestcloud-9d02f</span>
              </div>
              <div>
                <strong class="text-gray-900 dark:text-white">√öltima Actualizaci√≥n:</strong>
                <span class="text-gray-600 dark:text-gray-400">29 de junio de 2025</span>
              </div>
            </div>
          </div>

        </div>
      </div>
    </div>
  </div>
</LayoutSidebar>

<script>
  // Precargar Firebase
  import('../scripts/firebase-preload.js');
</script>

<script>
  document.addEventListener('DOMContentLoaded', async () => {
    const btnInicializar = document.getElementById('btn-inicializar');
    const btnTestSalida = document.getElementById('btn-test-salida');
    const estadoSistema = document.getElementById('estado-sistema');
    const mensajeEstado = document.getElementById('mensaje-estado');

    // Funci√≥n para mostrar estado
    function mostrarEstado(tipo, mensaje) {
      const colores = {
        'info': 'bg-blue-50 dark:bg-blue-900/20 border-blue-200 dark:border-blue-800',
        'success': 'bg-green-50 dark:bg-green-900/20 border-green-200 dark:border-green-800',
        'error': 'bg-red-50 dark:bg-red-900/20 border-red-200 dark:border-red-800',
        'warning': 'bg-yellow-50 dark:bg-yellow-900/20 border-yellow-200 dark:border-yellow-800'
      };
      
      estadoSistema.className = `mt-6 p-4 rounded-lg border ${colores[tipo] || colores.info}`;
      mensajeEstado.innerHTML = mensaje;
    }

    // Inicializar colecciones
    btnInicializar?.addEventListener('click', async () => {
      try {
        btnInicializar.disabled = true;
        btnInicializar.innerHTML = '‚è≥ Inicializando...';
        
        mostrarEstado('info', 'üîÑ Inicializando colecciones de Firebase...');

        // Importar e inicializar
        const { inicializarColeccionHistorial } = await import('../scripts/inicializar-historial.js');
        const resultado = await inicializarColeccionHistorial();
        
        mostrarEstado('success', `‚úÖ Colecciones inicializadas exitosamente.<br>Documento de inicializaci√≥n: ${resultado}`);
        
      } catch (error) {
        mostrarEstado('error', `‚ùå Error al inicializar: ${error.message}`);
      } finally {
        btnInicializar.disabled = false;
        btnInicializar.innerHTML = 'üöÄ Inicializar Colecciones';
      }
    });

    // Probar sistema de salida
    btnTestSalida?.addEventListener('click', async () => {
      try {
        btnTestSalida.disabled = true;
        btnTestSalida.innerHTML = '‚è≥ Probando...';
        
        mostrarEstado('info', 'üß™ Ejecutando prueba del sistema de salida...');

        // Esperar a que Firebase est√© listo
        let intentos = 0;
        const maxIntentos = 30;
        
        while (!window.darSalidaVisitante && intentos < maxIntentos) {
          await new Promise(resolve => setTimeout(resolve, 100));
          intentos++;
        }

        if (!window.darSalidaVisitante) {
          throw new Error('No se pudo cargar el sistema de visitantes');
        }

        mostrarEstado('success', `‚úÖ Sistema funcionando correctamente.<br>Funci√≥n darSalidaVisitante disponible.`);
        
      } catch (error) {
        mostrarEstado('error', `‚ùå Error en prueba: ${error.message}`);
      } finally {
        btnTestSalida.disabled = false;
        btnTestSalida.innerHTML = 'üß™ Probar Sistema de Salida';
      }
    });
  });
</script>
